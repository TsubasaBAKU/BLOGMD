---
title: '深入JVM:类文件结构'
date: 2016-07-28 15:47:21
tags:
	- JVM
	- 类文件结构
categories:
	- JAVA
---
Java在刚刚诞生时就曾经提出一个非常著名的口号：“一次编写，到处运行”。这句话充分表达了软件开发人员对冲破平台接线的渴求。而“与平台无关”的理想最终实现在操作系统的应用层上：Sun公司以及其它虚拟机提供商发布了许多可以运行在各种不同平台上的虚拟机，这些虚拟机都可以载入和执行同一种与平台无关的文件：字节码。
实现语言无关性的基础仍然是虚拟机和字节码的存储格式。Java虚拟机不和包括Java在内的任何语言绑定，它只于“Class文件”这种特定的而进行至文件格式所关联，虚拟机并不关心Class的来源是何种语言。
![cmd-markdown-logo](https://raw.githubusercontent.com/TsubasaBAKU/BLOGIMG/master/java虚拟机提供的平台无关性.png)
<!--more-->

# Class类文件的结构

Class文件时一组以8位字节为基础的二进制流，各个数据项目严格按照顺序紧凑地排列在Class文件之中，中间没有添加任何分隔符，这使得整个Class文件中存储的几乎都是程序运行必要的数据。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。

根据Java虚拟机规范的规定，Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种伪结构中只有两种数据类型：无符号数和表。

无符号数属于基本的数据类型，以u1，u2，u4，u8分别代表1个字节，2个字节，4个字节，8个字节的无符号数。表则是由多个无符号数或者其他表作为数据项构成的符合数据类型，所有 表都习惯性的以“info”结尾。表用于描述有层次关系的符合结构的数据，整个Class文件本质上就是一张表。
![cmd-markdown-logo](https://raw.githubusercontent.com/TsubasaBAKU/BLOGIMG/master/Class文件结构.png)
无论是无符号数还是表，当需要描述同一类型但数量不定的多个数据时，经常会使用一个前置的容量计数器家若干个连续的数据项的形式。

## 魔数与Class文件版本

每个Class文件的头四个字节称为“魔数”，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。使用魔数而不是扩展名来进行识别主要是基于安全方面的考虑，因为文件扩展名可以随意改动。

紧接着魔数的4个字节存储的Class文件版本号：第5和第6自己是次版本号，第7和第8字节是主版本号。

## 常量池

紧接着主次版本号的是常量池入口，常量池可以理解为Class文件中的资源仓库，它是Class文件结构中与其它项目关联最多的数据类型，也是Class文件空间最大的项目之一，同时也是Class文件中第一个出现的表类型数据项目。

由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一个u2类型的数据，代表常量池容量的计数值，范围是1~21，将第0项空出来的目的在与满足后面某些指向常量池的索引值的数据在特定情况下需要表达“不引用任何一个常量池项目”的含义。这种情况下将索引值置为0来表示。

常量池中主要有两大类常量：字面量和符号引用。字面量比较接近于Java语言层面的常量概念，比如文本字符串，声明为final的常量等。而符号引用则属于编译原理方面的概念，包括了下面三类常量：

1. 类和接口的全限定名
2. 字段的名称和描述符
3. 方法的名称和描述符

**Java代码在javac编译的时候，并不像C和C++那样有“连接”这一步骤，而是在虚拟机加载Class文件的时候进行动态链接。也就是说，在Class文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法的符号引用不经过运行时转换的话就无法得到相应的真正的入口地址，也就无法被虚拟机使用。当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时或者运行时解析，翻译到具体的内存之中。**

## 访问标志

在常量池结束后，紧接着的两个字节代表访问标志，这个标志用于识别一些类或者接口层次的访问呢信息，包括：这个Class是类还是接口；是否定义为public类型；是否蒂尼为abstract类型等等。

## 类索引、父类索引与接口索引集合

类索引用于确定这个类的全限定名，父类索引用于确定这个类的父类的全限定名，接口索引集合用来描述这个类实现了哪些接口。

**关于常量池还有许多其他的内容，这里不再继续讨论。**